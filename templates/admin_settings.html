{% extends "admin_base.html" %}

{% block title %}System Settings - Admin{% endblock %}
{% block header_title %}System Settings{% endblock %}

{% block content %}
<div x-data="settingsApp()">
    <!-- Toast Notification -->
    <div x-show="showToast" x-cloak x-transition
        class="fixed top-4 right-4 z-50 max-w-sm w-full bg-gray-800 border-l-4 rounded-lg shadow-lg overflow-hidden"
        :class="toastType === 'success' ? 'border-emerald-500' : 'border-red-500'">
        <div class="p-4 flex items-center">
            <div class="flex-shrink-0">
                <i :class="toastType === 'success' ? 'fas fa-check-circle text-emerald-500' : 'fas fa-exclamation-circle text-red-500'"
                    class="text-2xl"></i>
            </div>
            <div class="ml-3 flex-1">
                <p class="text-sm font-medium text-white" x-text="toastMessage"></p>
            </div>
            <button @click="showToast = false" class="ml-4 text-gray-400 hover:text-white">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <div class="bg-gray-800 shadow overflow-hidden sm:rounded-lg border border-gray-700">
        <div class="px-4 py-5 sm:px-6 border-b border-gray-700">
            <h3 class="text-lg leading-6 font-medium text-white">Platform Configuration</h3>
            <p class="mt-1 max-w-2xl text-sm text-gray-400">Manage global system settings.</p>
        </div>
        <div class="border-t border-gray-700 px-4 py-5 sm:p-0">
            <dl class="sm:divide-y sm:divide-gray-700">
                <!-- Platform Fee -->
                <div class="py-4 sm:py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                    <dt class="text-sm font-medium text-gray-400">Platform Fee (%)</dt>
                    <dd class="mt-1 text-sm sm:mt-0 sm:col-span-2">
                        <input type="number" x-model="settings.platform_fee" @input="markChanged()"
                            class="bg-gray-700 text-white shadow-sm focus:ring-emerald-500 focus:border-emerald-500 block w-full sm:text-sm border-gray-600 rounded-md max-w-xs">
                        <p class="mt-1 text-xs text-gray-500">Percentage fee charged on transactions</p>
                    </dd>
                </div>

                <!-- Maintenance Mode -->
                <div class="py-4 sm:py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                    <dt class="text-sm font-medium text-gray-400">Maintenance Mode</dt>
                    <dd class="mt-1 text-sm sm:mt-0 sm:col-span-2 flex items-center">
                        <button type="button"
                            @click="settings.maintenance_mode = !settings.maintenance_mode; markChanged()"
                            :class="settings.maintenance_mode ? 'bg-emerald-600' : 'bg-gray-600'"
                            class="relative inline-flex flex-shrink-0 h-6 w-11 border-2 border-transparent rounded-full cursor-pointer transition-colors ease-in-out duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500"
                            role="switch" aria-checked="false">
                            <span class="sr-only">Toggle maintenance mode</span>
                            <span aria-hidden="true"
                                :class="settings.maintenance_mode ? 'translate-x-5' : 'translate-x-0'"
                                class="pointer-events-none inline-block h-5 w-5 rounded-full bg-white shadow transform ring-0 transition ease-in-out duration-200"></span>
                        </button>
                        <span class="ml-3 text-sm text-gray-400"
                            x-text="settings.maintenance_mode ? 'Enabled' : 'Disabled'"></span>
                    </dd>
                </div>

                <!-- Allow New Registrations -->
                <div class="py-4 sm:py-5 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-6">
                    <dt class="text-sm font-medium text-gray-400">Allow New Registrations</dt>
                    <dd class="mt-1 text-sm sm:mt-0 sm:col-span-2 flex items-center">
                        <button type="button"
                            @click="settings.allow_registrations = !settings.allow_registrations; markChanged()"
                            :class="settings.allow_registrations ? 'bg-emerald-600' : 'bg-gray-600'"
                            class="relative inline-flex flex-shrink-0 h-6 w-11 border-2 border-transparent rounded-full cursor-pointer transition-colors ease-in-out duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500"
                            role="switch" aria-checked="false">
                            <span class="sr-only">Toggle registrations</span>
                            <span aria-hidden="true"
                                :class="settings.allow_registrations ? 'translate-x-5' : 'translate-x-0'"
                                class="pointer-events-none inline-block h-5 w-5 rounded-full bg-white shadow transform ring-0 transition ease-in-out duration-200"></span>
                        </button>
                        <span class="ml-3 text-sm text-gray-400"
                            x-text="settings.allow_registrations ? 'Allowed' : 'Paused'"></span>
                    </dd>
                </div>
            </dl>
        </div>

        <!-- Save Button Footer -->
        <div class="px-4 py-4 sm:px-6 bg-gray-900 border-t border-gray-700 flex items-center justify-between">
            <div class="flex items-center">
                <template x-if="hasChanges">
                    <span class="text-sm text-yellow-400 flex items-center">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        You have unsaved changes
                    </span>
                </template>
            </div>
            <div class="flex gap-3">
                <button @click="resetChanges()" :disabled="!hasChanges"
                    :class="hasChanges ? 'text-gray-400 hover:text-white' : 'text-gray-600 cursor-not-allowed'"
                    class="px-4 py-2 text-sm font-medium transition-colors">
                    Reset
                </button>
                <button @click="saveAllSettings()" :disabled="!hasChanges || isSaving"
                    :class="hasChanges && !isSaving ? 'bg-gradient-to-r from-emerald-600 to-cyan-600 hover:from-emerald-700 hover:to-cyan-700' : 'bg-gray-700 cursor-not-allowed'"
                    class="px-6 py-2 text-white text-sm font-medium rounded-lg shadow-lg transition-all duration-200 flex items-center">
                    <template x-if="isSaving">
                        <i class="fas fa-spinner fa-spin mr-2"></i>
                    </template>
                    <template x-if="!isSaving">
                        <i class="fas fa-save mr-2"></i>
                    </template>
                    <span x-text="isSaving ? 'Saving...' : 'Save Changes'"></span>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    function settingsApp() {
        return {
            settings: {
                platform_fee: 5,
                maintenance_mode: false,
                allow_registrations: true
            },
            originalSettings: {},
            hasChanges: false,
            isSaving: false,
            showToast: false,
            toastMessage: '',
            toastType: 'success',
            currentUser: JSON.parse(localStorage.getItem('flb_user') || '{}'),

            init() {
                if (this.currentUser.account_type !== 'super_admin') {
                    window.location.href = '/dashboard';
                    return;
                }
                this.fetchSettings();
            },

            async fetchSettings() {
                // Mock fetch - replace with actual API call
                console.log('Fetching settings...');
                // Store original settings for reset
                this.originalSettings = JSON.parse(JSON.stringify(this.settings));
            },

            markChanged() {
                this.hasChanges = JSON.stringify(this.settings) !== JSON.stringify(this.originalSettings);
            },

            resetChanges() {
                this.settings = JSON.parse(JSON.stringify(this.originalSettings));
                this.hasChanges = false;
                this.showToastNotification('Changes discarded', 'success');
            },

            async saveAllSettings() {
                if (!this.hasChanges || this.isSaving) return;

                this.isSaving = true;

                try {
                    // Mock API call - replace with actual endpoint
                    await new Promise(resolve => setTimeout(resolve, 1000));

                    console.log('Saving all settings:', this.settings);

                    // Update original settings after successful save
                    this.originalSettings = JSON.parse(JSON.stringify(this.settings));
                    this.hasChanges = false;

                    this.showToastNotification('Settings saved successfully!', 'success');
                } catch (error) {
                    console.error('Error saving settings:', error);
                    this.showToastNotification('Failed to save settings', 'error');
                } finally {
                    this.isSaving = false;
                }
            },

            showToastNotification(message, type = 'success') {
                this.toastMessage = message;
                this.toastType = type;
                this.showToast = true;

                // Auto-hide after 3 seconds
                setTimeout(() => {
                    this.showToast = false;
                }, 3000);
            }
        }
    }
</script>
{% endblock %}