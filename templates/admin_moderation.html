{% extends "base.html" %}

{% block title %}Content Moderation - Admin{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-100" x-data="moderationApp()">
    <div class="py-10">
        <header>
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center">
                <h1 class="text-3xl font-bold leading-tight text-gray-900">
                    Content Moderation
                </h1>
                <a href="/dashboard" class="text-primary-600 hover:text-primary-900">Back to Dashboard</a>
            </div>
        </header>
        <main>
            <div class="max-w-7xl mx-auto sm:px-6 lg:px-8 mt-8">
                <div class="bg-white shadow overflow-hidden sm:rounded-lg">
                    <div class="px-4 py-5 sm:px-6 flex justify-between items-center">
                        <div>
                            <h3 class="text-lg leading-6 font-medium text-gray-900">Reports</h3>
                            <p class="mt-1 max-w-2xl text-sm text-gray-500">Review and resolve user reports.</p>
                        </div>
                        <button @click="fetchReports()" class="text-primary-600 hover:text-primary-900">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                    <div class="border-t border-gray-200">
                        <ul role="list" class="divide-y divide-gray-200">
                            <template x-for="report in reports" :key="report.id">
                                <li class="px-4 py-4 sm:px-6 hover:bg-gray-50">
                                    <div class="flex items-center justify-between">
                                        <p class="text-sm font-medium text-primary-600 truncate" x-text="report.report_type.toUpperCase()"></p>
                                        <div class="ml-2 flex-shrink-0 flex">
                                            <p class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full"
                                               :class="{
                                                   'bg-yellow-100 text-yellow-800': report.status === 'pending',
                                                   'bg-green-100 text-green-800': report.status === 'resolved',
                                                   'bg-red-100 text-red-800': report.status === 'dismissed'
                                               }"
                                               x-text="report.status">
                                            </p>
                                        </div>
                                    </div>
                                    <div class="mt-2 sm:flex sm:justify-between">
                                        <div class="sm:flex">
                                            <p class="flex items-center text-sm text-gray-500">
                                                <i class="fas fa-user mr-1.5 text-gray-400"></i>
                                                Reporter ID: <span x-text="report.reporter_id"></span>
                                            </p>
                                            <p class="mt-2 flex items-center text-sm text-gray-500 sm:mt-0 sm:ml-6">
                                                <i class="fas fa-info-circle mr-1.5 text-gray-400"></i>
                                                <span x-text="report.description"></span>
                                            </p>
                                        </div>
                                        <div class="mt-2 flex items-center text-sm text-gray-500 sm:mt-0">
                                            <i class="fas fa-calendar mr-1.5 text-gray-400"></i>
                                            <p x-text="formatDate(report.created_at)"></p>
                                        </div>
                                    </div>
                                    <div class="mt-4 flex justify-end space-x-3" x-show="report.status === 'pending'">
                                        <button @click="resolveReport(report.id, 'dismissed')" class="inline-flex items-center px-3 py-1 border border-gray-300 shadow-sm text-xs font-medium rounded text-gray-700 bg-white hover:bg-gray-50">
                                            Dismiss
                                        </button>
                                        <button @click="resolveReport(report.id, 'resolved')" class="inline-flex items-center px-3 py-1 border border-transparent shadow-sm text-xs font-medium rounded text-white bg-primary-600 hover:bg-primary-700">
                                            Resolve
                                        </button>
                                    </div>
                                </li>
                            </template>
                            <li x-show="reports.length === 0" class="px-4 py-8 text-center text-gray-500">
                                No reports found.
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<script>
function moderationApp() {
    return {
        reports: [],
        currentUser: JSON.parse(localStorage.getItem('flb_user') || '{}'),

        init() {
            if (!['admin', 'super_admin', 'moderator'].includes(this.currentUser.account_type)) {
                window.location.href = '/dashboard';
                return;
            }
            this.fetchReports();
        },

        async fetchReports() {
            try {
                const response = await fetch('/admin/reports', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ admin_id: this.currentUser.id })
                });
                
                if (response.ok) {
                    this.reports = await response.json();
                } else {
                    console.error('Failed to fetch reports');
                }
            } catch (error) {
                console.error('Error:', error);
            }
        },

        async resolveReport(reportId, status) {
            try {
                const response = await fetch('/admin/reports/resolve', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        admin_id: this.currentUser.id,
                        report_id: reportId,
                        status: status,
                        resolution_notes: 'Resolved via dashboard'
                    })
                });

                if (response.ok) {
                    this.fetchReports();
                } else {
                    alert('Action failed');
                }
            } catch (error) {
                console.error('Error:', error);
            }
        },

        formatDate(dateString) {
            if (!dateString) return '';
            return new Date(dateString).toLocaleDateString();
        }
    }
}
</script>
{% endblock %}
