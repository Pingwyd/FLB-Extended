{% extends "admin_base.html" %}

{% block title %}Content Moderation - Admin{% endblock %}
{% block header_title %}Content Moderation{% endblock %}

{% block content %}
<div x-data="moderationApp()">
    <div class="bg-gray-800 shadow overflow-hidden sm:rounded-lg border border-gray-700">
        <div class="px-4 py-5 sm:px-6 flex justify-between items-center border-b border-gray-700">
            <div>
                <h3 class="text-lg leading-6 font-medium text-white">Reports</h3>
                <p class="mt-1 max-w-2xl text-sm text-gray-400">Review and resolve user reports.</p>
            </div>
            <button @click="fetchReports()" class="text-blue-400 hover:text-blue-300 transition-colors">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
        </div>
        <div class="border-t border-gray-700">
            <ul role="list" class="divide-y divide-gray-700">
                <template x-for="report in reports" :key="report.id">
                    <li class="px-4 py-4 sm:px-6 hover:bg-gray-700/50 transition-colors duration-150">
                        <div class="flex items-center justify-between">
                            <p class="text-sm font-medium text-blue-400 truncate" x-text="report.report_type.toUpperCase()"></p>
                            <div class="ml-2 flex-shrink-0 flex">
                                <p class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full"
                                   :class="{
                                       'bg-yellow-900 text-yellow-200': report.status === 'pending',
                                       'bg-green-900 text-green-200': report.status === 'resolved',
                                       'bg-red-900 text-red-200': report.status === 'dismissed'
                                   }"
                                   x-text="report.status">
                                </p>
                            </div>
                        </div>
                        <div class="mt-2 sm:flex sm:justify-between">
                            <div class="sm:flex">
                                <p class="flex items-center text-sm text-gray-400">
                                    <i class="fas fa-user mr-1.5 text-gray-500"></i>
                                    Reporter ID: <span x-text="report.reporter_id"></span>
                                </p>
                                <p class="mt-2 flex items-center text-sm text-gray-400 sm:mt-0 sm:ml-6">
                                    <i class="fas fa-info-circle mr-1.5 text-gray-500"></i>
                                    <span x-text="report.description"></span>
                                </p>
                            </div>
                            <div class="mt-2 flex items-center text-sm text-gray-400 sm:mt-0">
                                <i class="fas fa-calendar mr-1.5 text-gray-500"></i>
                                <p x-text="formatDate(report.created_at)"></p>
                            </div>
                        </div>
                        <div class="mt-4 flex justify-end space-x-3" x-show="report.status === 'pending'">
                            <button @click="resolveReport(report.id, 'dismissed')" class="inline-flex items-center px-3 py-1 border border-gray-600 shadow-sm text-xs font-medium rounded text-gray-300 bg-gray-700 hover:bg-gray-600 transition-colors">
                                Dismiss
                            </button>
                            <button @click="resolveReport(report.id, 'resolved')" class="inline-flex items-center px-3 py-1 border border-transparent shadow-sm text-xs font-medium rounded text-white bg-blue-600 hover:bg-blue-700 transition-colors">
                                Resolve
                            </button>
                        </div>
                    </li>
                </template>
                <li x-show="reports.length === 0" class="px-4 py-8 text-center text-gray-500">
                    No reports found.
                </li>
            </ul>
        </div>
    </div>
</div>

<script>
function moderationApp() {
    return {
        reports: [],
        currentUser: JSON.parse(localStorage.getItem('flb_user') || '{}'),

        init() {
            if (!['admin', 'super_admin', 'moderator'].includes(this.currentUser.account_type)) {
                window.location.href = '/dashboard';
                return;
            }
            this.fetchReports();
        },

        async fetchReports() {
            try {
                const response = await fetch('/admin/reports', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ admin_id: this.currentUser.id })
                });
                
                if (response.ok) {
                    this.reports = await response.json();
                } else {
                    console.error('Failed to fetch reports');
                }
            } catch (error) {
                console.error('Error:', error);
            }
        },

        async resolveReport(reportId, status) {
            if (!confirm(`Mark report as ${status}?`)) return;

            try {
                const response = await fetch(`/admin/reports/${reportId}/resolve`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        admin_id: this.currentUser.id,
                        status: status,
                        resolution_notes: 'Resolved via dashboard'
                    })
                });

                if (response.ok) {
                    this.fetchReports();
                } else {
                    const data = await response.json();
                    alert(data.error || 'Action failed');
                }
            } catch (error) {
                console.error('Error:', error);
            }
        },

        formatDate(dateString) {
            if (!dateString) return '';
            return new Date(dateString).toLocaleDateString();
        }
    }
}
</script>
{% endblock %}
