{% extends "base.html" %}

{% block content %}
<div class="bg-gray-50 dark:bg-gray-900 min-h-screen py-8" x-data="editListing()">
    <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="bg-white dark:bg-gray-800 shadow sm:rounded-lg">
            <div class="px-4 py-5 sm:p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white">Edit Listing</h3>
                    <button type="button" onclick="window.history.back()"
                        class="inline-flex items-center px-3 py-2 border border-gray-300 dark:border-gray-600 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                        <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                        </svg>
                        Back
                    </button>
                </div>

                <div x-show="loading" class="flex justify-center py-10">
                    <i class="fa-solid fa-circle-notch fa-spin text-4xl text-primary-600"></i>
                </div>

                <form x-show="!loading" class="mt-5 space-y-6" @submit.prevent="updateListing">
                    <!-- Title -->
                    <div>
                        <label for="title"
                            class="block text-sm font-medium text-gray-700 dark:text-gray-300">Title</label>
                        <div class="mt-1">
                            <input type="text" name="title" id="title" x-model="formData.title" required
                                class="shadow-sm focus:ring-primary-500 focus:border-primary-500 block w-full sm:text-sm border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700 dark:text-white">
                        </div>
                    </div>

                    <!-- Price -->
                    <div>
                        <label for="price" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Price
                            (₦)</label>
                        <div class="mt-1 relative rounded-md shadow-sm">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <span class="text-gray-500 dark:text-gray-400 sm:text-sm">₦</span>
                            </div>
                            <input type="number" name="price" id="price" x-model="formData.price" required
                                class="focus:ring-primary-500 focus:border-primary-500 block w-full pl-16 pr-12 sm:text-sm border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700 dark:text-white"
                                style="padding-left: 3.5rem;">
                        </div>
                    </div>

                    <!-- Description -->
                    <div>
                        <label for="description"
                            class="block text-sm font-medium text-gray-700 dark:text-gray-300">Description</label>
                        <div class="mt-1">
                            <textarea id="description" name="description" rows="3" x-model="formData.description"
                                class="shadow-sm focus:ring-primary-500 focus:border-primary-500 block w-full sm:text-sm border border-gray-300 dark:border-gray-600 rounded-md p-3 dark:bg-gray-700 dark:text-white"></textarea>
                        </div>
                    </div>

                    <!-- Location -->
                    <div class="grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-2">
                        <div>
                            <label for="location_state"
                                class="block text-sm font-medium text-gray-700 dark:text-gray-300">State</label>
                            <div class="mt-1">
                                <input type="text" name="location_state" id="location_state"
                                    x-model="formData.location_state"
                                    class="shadow-sm focus:ring-primary-500 focus:border-primary-500 block w-full sm:text-sm border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700 dark:text-white">
                            </div>
                        </div>

                        <div>
                            <label for="location_area"
                                class="block text-sm font-medium text-gray-700 dark:text-gray-300">Area/City</label>
                            <div class="mt-1">
                                <input type="text" name="location_area" id="location_area"
                                    x-model="formData.location_area"
                                    class="shadow-sm focus:ring-primary-500 focus:border-primary-500 block w-full sm:text-sm border-gray-300 dark:border-gray-600 rounded-md dark:bg-gray-700 dark:text-white">
                            </div>
                        </div>
                    </div>

                    <!-- Existing Images -->
                    <div x-show="existingImages.length > 0">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Current
                            Images</label>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                            <template x-for="(image, index) in existingImages" :key="index">
                                <div class="relative group">
                                    <img :src="image"
                                        class="w-full h-32 object-cover rounded-lg border border-gray-300 dark:border-gray-600">
                                    <button type="button" @click="removeImage(index)"
                                        class="absolute top-2 right-2 bg-red-600 text-white rounded-full p-2 opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-700">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M6 18L18 6M6 6l12 12" />
                                        </svg>
                                    </button>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Add New Images -->
                    <div>
                        <label for="new_images" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Add
                            New Images</label>
                        <div class="mt-1">
                            <input type="file" id="new_images" name="images" multiple accept="image/*"
                                @change="handleImageUpload"
                                class="block w-full text-sm text-gray-500 dark:text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-primary-50 file:text-primary-700 hover:file:bg-primary-100 dark:file:bg-gray-700 dark:file:text-gray-300">
                            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Upload additional images
                                (optional).</p>
                        </div>
                    </div>

                    <!-- Existing Videos -->
                    <div x-show="existingVideos.length > 0">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Current
                            Videos</label>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <template x-for="(video, index) in existingVideos" :key="index">
                                <div class="relative group">
                                    <video :src="video"
                                        class="w-full h-32 object-cover rounded-lg border border-gray-300 dark:border-gray-600"
                                        controls></video>
                                    <button type="button" @click="removeVideo(index)"
                                        class="absolute top-2 right-2 bg-red-600 text-white rounded-full p-2 opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-700">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M6 18L18 6M6 6l12 12" />
                                        </svg>
                                    </button>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Add New Videos -->
                    <div>
                        <label for="new_videos" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Add
                            New Videos</label>
                        <div class="mt-1">
                            <input type="file" id="new_videos" name="videos" multiple accept="video/*"
                                @change="handleVideoUpload"
                                class="block w-full text-sm text-gray-500 dark:text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-primary-50 file:text-primary-700 hover:file:bg-primary-100 dark:file:bg-gray-700 dark:file:text-gray-300">
                            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Upload additional videos
                                (optional).</p>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <div class="flex justify-end space-x-3">
                        <button type="button" @click="deleteListing"
                            class="bg-red-50 dark:bg-red-900 py-2 px-4 border border-red-300 dark:border-red-700 rounded-md shadow-sm text-sm font-medium text-red-700 dark:text-red-200 hover:bg-red-100 dark:hover:bg-red-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                            Delete Listing
                        </button>
                        <button type="submit"
                            class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                            Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    function editListing() {
        return {
            loading: true,
            listingId: null,
            formData: {
                title: '',
                price: '',
                description: '',
                location_state: '',
                location_area: ''
            },
            existingImages: [],
            existingVideos: [],
            removedImages: [],
            removedVideos: [],
            imageFiles: [],
            videoFiles: [],

            async init() {
                // Get listing ID from URL
                const pathParts = window.location.pathname.split('/');
                this.listingId = pathParts[pathParts.length - 2]; // /marketplace/{id}/edit

                await this.fetchListing();
            },

            async fetchListing() {
                try {
                    const response = await fetch(`/listings/${this.listingId}`);
                    if (response.ok) {
                        const listing = await response.json();
                        this.formData.title = listing.title;
                        this.formData.price = listing.price;
                        this.formData.description = listing.description || '';
                        this.formData.location_state = listing.location_state || '';
                        this.formData.location_area = listing.location_area || '';
                        this.existingImages = listing.images || [];
                        this.existingVideos = listing.videos || [];
                    } else {
                        alert('Failed to load listing');
                    }
                } catch (error) {
                    console.error('Error fetching listing:', error);
                    alert('An error occurred while loading the listing');
                } finally {
                    this.loading = false;
                }
            },

            removeImage(index) {
                const removedImage = this.existingImages[index];
                this.removedImages.push(removedImage);
                this.existingImages.splice(index, 1);
            },

            removeVideo(index) {
                const removedVideo = this.existingVideos[index];
                this.removedVideos.push(removedVideo);
                this.existingVideos.splice(index, 1);
            },

            handleImageUpload(event) {
                this.imageFiles = event.target.files;
            },

            handleVideoUpload(event) {
                this.videoFiles = event.target.files;
            },

            async updateListing() {
                const userStr = localStorage.getItem('flb_user');
                if (!userStr) {
                    alert('Please login to update listings.');
                    window.location.href = '/login-page';
                    return;
                }
                const user = JSON.parse(userStr);

                try {
                    const formData = new FormData();
                    formData.append('owner_id', user.id);
                    formData.append('title', this.formData.title);
                    formData.append('price', this.formData.price);
                    formData.append('description', this.formData.description);
                    formData.append('location_state', this.formData.location_state);
                    formData.append('location_area', this.formData.location_area);

                    // Add removed images/videos as comma-separated strings
                    if (this.removedImages.length > 0) {
                        formData.append('remove_images', this.removedImages.join(','));
                    }
                    if (this.removedVideos.length > 0) {
                        formData.append('remove_videos', this.removedVideos.join(','));
                    }

                    // Append new images if any
                    for (let i = 0; i < this.imageFiles.length; i++) {
                        formData.append('images', this.imageFiles[i]);
                    }

                    // Append new videos if any
                    for (let i = 0; i < this.videoFiles.length; i++) {
                        formData.append('videos', this.videoFiles[i]);
                    }

                    const response = await fetch(`/listings/${this.listingId}/update`, {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        alert('Listing updated successfully!');
                        window.location.href = `/marketplace/${this.listingId}`;
                    } else {
                        const data = await response.json();
                        alert(data.error || 'Failed to update listing.');
                    }
                } catch (error) {
                    console.error('Error updating listing:', error);
                    alert('An error occurred.');
                }
            },

            async deleteListing() {
                if (!confirm('Are you sure you want to delete this listing? This action cannot be undone.')) {
                    return;
                }

                // TODO: Implement delete endpoint
                alert('Delete functionality to be implemented.');
            }
        }
    }
</script>
{% endblock %}